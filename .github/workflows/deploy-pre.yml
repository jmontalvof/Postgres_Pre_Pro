name: Desplegar a PreproducciÃ³n

on:
  workflow_dispatch:

jobs:
  deploy-pre:
    name: Despliegue en PreproducciÃ³n
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Clonar repositorio
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Necesario para crear tags

      - name: ğŸ” Obtener versiÃ³n del pom.xml
        id: version
        run: |
          sudo apt-get update && sudo apt-get install -y libxml2-utils
          version=$(xmllint --xpath "string(//project/version)" pom.xml)
          echo "ğŸ”– VersiÃ³n detectada: $version"
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: ğŸ§± Instalar dependencias
        run: |
          sudo apt-get install -y postgresql-client
          pip install -r requirements.txt

      - name: ğŸš€ Desplegar scripts en Pre
        env:
          DB_NAME: ${{ secrets.PGDATABASE_DEV }}
          DB_USER: ${{ secrets.PGUSER_DEV }}
          DB_PASSWORD: ${{ secrets.PGPASSWORD_DEV }}
          DB_HOST: ${{ secrets.PGHOST_DEV }}
          DB_PORT: ${{ secrets.PGPORT_DEV }}
        run: python main.py

      - name: ğŸ·ï¸ Crear y subir tag
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag -a v${{ steps.version.outputs.version }} -m "VersiÃ³n aprobada para producciÃ³n"
          git push origin v${{ steps.version.outputs.version }}

      - name: ğŸš€ Lanzar despliegue a ProducciÃ³n desde Tag
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: despliegue-produccion-tag
          client-payload: '{"tag": "v${{ steps.version.outputs.version }}"}'
