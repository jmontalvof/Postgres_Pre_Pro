name: Desplegar ProducciÃ³n desde Tag

on:
  push:
    tags:
      - 'v*.*.*'  # Ejecutar sÃ³lo cuando se haga push de un tag tipo v1.0.0

jobs:
  deploy:
    name: Desplegar en ProducciÃ³n desde tag
    runs-on: ubuntu-latest
    environment:
      name: produccion

    steps:
      - name: ğŸ’¾ Clonar repo desde tag
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # necesario para obtener los tags

      - name: ğŸ“‰ Instalar PostgreSQL client y dependencias Python
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
          pip install -r requirements.txt

      - name: ğŸ” Validar archivo scripts_PRO.txt
        run: |
          if [ ! -f scripts_PRO.txt ]; then
            echo "âŒ No se encontrÃ³ scripts_PRO.txt"
            exit 1
          fi
          if [ ! -s scripts_PRO.txt ]; then
            echo "âŒ scripts_PRO.txt estÃ¡ vacÃ­o"
            exit 1
          fi

      - name: âœ¨ Ejecutar main.py
        env:
          DB_NAME: ${{ secrets.PGDATABASE_PRO }}
          DB_USER: ${{ secrets.PGUSER_PRO }}
          DB_PASSWORD: ${{ secrets.PGPASSWORD_PRO }}
          DB_HOST: ${{ secrets.PGHOST_PRO }}
          DB_PORT: ${{ secrets.PGPORT_PRO }}
          GITHUB_REF: ${{ github.ref }}
        run: python main.py

      - name: ğŸ‰ Finalizado
        run: echo "ğŸŒŸ Despliegue a ProducciÃ³n desde tag ejecutado correctamente."

