name: "Postgres_Pre_Pro - SQL Deployment"

on:
  push:
    branches:
      - main
      - development
    paths:
      - 'src/*.sql'
      - 'src/scripts*.txt'

jobs:
  execute-sql:
    runs-on: ubuntu-latest

    steps:
      - name: Clonar el repo
        uses: actions/checkout@v3

      - name: Instalar cliente PostgreSQL
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Establecer variables de entorno por rama
        id: variables
        env:
          PGHOST_PRO: ${{ secrets.PGHOST_PRO }}
          PGUSER_PRO: ${{ secrets.PGUSER_PRO }}
          PGPASSWORD_PRO: ${{ secrets.PGPASSWORD_PRO }}
          PGPORT_PRO: ${{ secrets.PGPORT_PRO }}
          PGDATABASE_PRO: ${{ secrets.PGDATABASE_PRO }}
          PGHOST_DEV: ${{ secrets.PGHOST_DEV }}
          PGUSER_DEV: ${{ secrets.PGUSER_DEV }}
          PGPASSWORD_DEV: ${{ secrets.PGPASSWORD_DEV }}
          PGPORT_DEV: ${{ secrets.PGPORT_DEV }}
          PGDATABASE_DEV: ${{ secrets.PGDATABASE_DEV }}
        run: |
          if [ "${GITHUB_REF##*/}" = "main" ]; then
            echo "host=${PGHOST_PRO}" >> $GITHUB_OUTPUT
            echo "user=${PGUSER_PRO}" >> $GITHUB_OUTPUT
            echo "password=${PGPASSWORD_PRO}" >> $GITHUB_OUTPUT
            echo "port=${PGPORT_PRO}" >> $GITHUB_OUTPUT
            echo "database=${PGDATABASE_PRO}" >> $GITHUB_OUTPUT
            echo "script_file=scripts_pro.txt" >> $GITHUB_OUTPUT
            echo "entorno=PRO" >> $GITHUB_OUTPUT
          else
            echo "host=${PGHOST_DEV}" >> $GITHUB_OUTPUT
            echo "user=${PGUSER_DEV}" >> $GITHUB_OUTPUT
            echo "password=${PGPASSWORD_DEV}" >> $GITHUB_OUTPUT
            echo "port=${PGPORT_DEV}" >> $GITHUB_OUTPUT
            echo "database=${PGDATABASE_DEV}" >> $GITHUB_OUTPUT
            echo "script_file=scripts_dev.txt" >> $GITHUB_OUTPUT
            echo "entorno=DEV" >> $GITHUB_OUTPUT
          fi

      - name: Probar conexiÃ³n a la base de datos
        run: |
          echo "ðŸ”— Conectando a ${{ steps.variables.outputs.database }} en entorno ${{ steps.variables.outputs.entorno }}"
          PGPASSWORD=${{ steps.variables.outputs.password }} psql             -h "${{ steps.variables.outputs.host }}"             -p "${{ steps.variables.outputs.port }}"             -U "${{ steps.variables.outputs.user }}"             -d "${{ steps.variables.outputs.database }}"             -c '\conninfo'

      - name: Ejecutar scripts listados
        run: |
          while IFS= read -r script; do
            echo "ðŸš€ Ejecutando src/$script"
            PGPASSWORD=${{ steps.variables.outputs.password }} psql               -h "${{ steps.variables.outputs.host }}"               -p "${{ steps.variables.outputs.port }}"               -U "${{ steps.variables.outputs.user }}"               -d "${{ steps.variables.outputs.database }}"               -f "src/$script"
          done < "src/${{ steps.variables.outputs.script_file }}"

      - name: NotificaciÃ³n al finalizar
        run: echo "âœ… Despliegue completado con Ã©xito en entorno ${{ steps.variables.outputs.entorno }}"
