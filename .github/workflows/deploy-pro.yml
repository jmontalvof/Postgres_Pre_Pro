name: 🚀 Despliegue a Producción desde Tag

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag aprobado para despliegue (ej: 1.0.0)'
        required: true

jobs:
  deploy:
    name: Desplegar en Producción
    runs-on: ubuntu-latest
    environment:
      name: produccion

    steps:
      - name: 🔁 Clonar código desde el tag aprobado
        uses: actions/checkout@v3
        with:
          ref: refs/tags/${{ github.event.inputs.tag }}

      - name: ⚙️ Instalar dependencias
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
          pip install -r requirements.txt

      - name: 📋 Validar existencia de scripts_PRO.txt
        run: |
          if [ ! -f scripts_PRO.txt ]; then
            echo "❌ El archivo scripts_PRO.txt no existe."
            exit 1
          fi
          if [ ! -s scripts_PRO.txt ]; then
            echo "❌ El archivo scripts_PRO.txt está vacío."
            exit 1
          fi

      - name: 🚀 Ejecutar scripts en producción
        env:
          DB_NAME: ${{ secrets.PGDATABASE_PRO }}
          DB_USER: ${{ secrets.PGUSER_PRO }}
          DB_PASSWORD: ${{ secrets.PGPASSWORD_PRO }}
          DB_HOST: ${{ secrets.PGHOST_PRO }}
          DB_PORT: ${{ secrets.PGPORT_PRO }}
          GITHUB_REF: refs/heads/main
        run: python main.py